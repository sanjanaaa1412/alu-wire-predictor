<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Wire Rod Property Prediction</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <style>
    body {
      background: linear-gradient(135deg, #3c1053, #ad5389);
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      overflow-y: auto; /* ‚úÖ Allows smooth scrolling */
    }
    .sidebar {
      background-color: #2E2E4D;
      min-height: 100vh;
      padding: 20px 10px;
    }
    .btn-sidebar {
      background-color: #2E2E4D;
      border: none;
      width: 100%;
      text-align: left;
      padding: 10px;
      color: white;
      transition: background-color 0.3s;
      border-radius: 0;
    }
    .btn-sidebar:hover, .btn-sidebar.active {
      background-color: #373760;
      cursor: pointer;
    }
    .container-fluid {
      height: 100vh;
    }
    .scrollable-content {
      height: 100vh;
      overflow-y: auto;
      padding: 20px;
    }
    .card {
      background-color: rgba(0, 0, 0, 0.3);
      color: white;
      padding: 20px;
      border-radius: 12px;
      border: 1px solid rgba(255, 255, 255, 0.1);
    }
    
    .form-control, .btn {
      border-radius: 0.25rem;
    }
    .btn-primary, .btn-secondary, .btn-danger {
      color: #fff;
    }
    .form-label {
      color: #FFFFFF;
      font-size: 0.8rem;
    }
    .form-control {
      height: calc(1.5em + 0.75rem + 2px);
    }
    #results .alert {
      padding: 15px 20px;
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      flex-wrap: wrap;
      max-width: 600px;
      margin: 0 auto;
    }
    #results .alert div:first-child {
      flex: 1 1 70%;
    }
    #results .alert button {
      white-space: nowrap;
    }
  </style>
</head>
<body>
  <div class="container-fluid">
    <div class="row h-100">
      <div class="col-md-2 sidebar d-flex flex-column justify-content-between">
        <div>
          <button class="btn-sidebar active" onclick="if (!hasPredicted) showPredictProperties()">Predict Properties</button>
          <button class="btn-sidebar" onclick="showBatchHistory()">Batch History</button>
          <button class="btn-sidebar" onclick="location.href='Dahsboard2.html'">Dashboard</button>
        </div>

        <!-- Profile Section -->
        <div class="d-flex align-items-center p-2 mt-4" style="cursor: pointer;" onclick="showWorkerInfo()">
          <img src="worker.png" alt="Worker" style="width: 40px; height: 40px; border-radius: 50%; background-color: white; padding: 2px;" />
          <span class="ms-2 text-white" style="font-size: 0.9rem;">Your Profile</span>
        </div>
      </div>

      <div class="col-md-10 scrollable-content">
        <div id="content-area"></div>
        <div id="results" style="margin-top: 30px;"></div>
      </div>      
    </div>
  </div>

  <!-- Worker Info Modal -->
  <div class="modal fade" id="workerModal" tabindex="-1" aria-labelledby="workerModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header bg-primary text-white">
          <h5 class="modal-title" id="workerModalLabel">üë∑‚Äç‚ôÇÔ∏è Worker Profile</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <p><strong>Name:</strong> Rakesh Sharma</p>
          <p><strong>ID:</strong> WRD-0042</p>
          <p><strong>Role:</strong> Line Supervisor</p>
          <p><strong>Shift:</strong> Night (8PM ‚Äì 4AM)</p>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    let hasPredicted = sessionStorage.getItem("hasPredicted") === "true";


    function showWorkerInfo() {
      const modal = new bootstrap.Modal(document.getElementById('workerModal'));
      modal.show();
    }

    // ‚úÖ Updated Classification Logic (Only 9.5 and 11.5 allowed)
    function classifyGrade(conductivity, diameter) {
      diameter = parseFloat(diameter);
      conductivity = parseFloat(conductivity);

      if (diameter === 9.5) {
        if (conductivity >= 61.5) return 'WE10';
        else if (conductivity >= 61.0) return 'WE20';
        else return 'WC10';
      } else if (diameter === 11.5) {
        if (conductivity >= 61.5) return 'WE12';
        else if (conductivity >= 61.0) return 'WE22';
        else return 'WC12';
      } else {
        return 'Unknown';
      }
    }

    function showPredictProperties() {
      document.getElementById('content-area').innerHTML = `
        <div class="card shadow">
          <h2 class="text-center">üîß Wire Rod Property Prediction System</h2>
          <form id="predictionForm" onsubmit="submitPrediction(event)">
            <div class="row g-2">
              <div class="col-md-3"><label class="form-label">%Fe</label><input type="number" name="fe" class="form-control" step="any"required></div>
              <div class="col-md-3"><label class="form-label">Emulsion Temperature</label><input type="number" name="emulsion_temp" class="form-control" step="any" required></div>
              <div class="col-md-3"><label class="form-label">Emulsion Pressure</label><input type="number" name="emulsion_pr" class="form-control" step="any" required></div>
              <div class="col-md-3"><label class="form-label">Rod Quench CW Exit</label><input type="number" name="rod_quench_cw_exit" class="form-control" step="any" required></div>
              <div class="col-md-3"><label class="form-label">Rod Quench CW Entry</label><input type="number" name="rod_quench_cw_entry" class="form-control" step="any" required></div>
              <div class="col-md-3"><label class="form-label">Casting Wheel RPM</label><input type="number" name="casting_wheel_rpm" class="form-control" step="any" required></div>
              <div class="col-md-3"><label class="form-label">RM Motor Cooling Water Pressure</label><input type="number" name="rm_motor_cooling_water_pressure" class="form-control" step="any" required></div>
              <div class="col-md-3"><label class="form-label">Rolling Mill Amp</label><input type="number" name="rolling_mill_amp" class="form-control" step="any" required></div>
              <div class="col-md-3"><label class="form-label">Cooling Water Flow</label><input type="number" name="cool_water_flow" class="form-control" step="any" required></div>
              <div class="col-md-3"><label class="form-label">Cooling Water Pressure</label><input type="number" name="cooling_water_pressure" class="form-control" step="any" required></div>
              <div class="col-md-3"><label class="form-label">Cooling Water Temp</label><input type="number" name="cooling_water_temp" class="form-control" step="any" required></div>
              <div class="col-md-3"><label class="form-label">Rolling Mill RPM</label><input type="number" name="rolling_mill_rpm" class="form-control" step="any" required></div>
              <div class="col-md-3"><label class="form-label">Diameter</label>
                <select name="diameter" class="form-control" required>
                  <option value="" selected disabled>Select</option>
                  <option value="9.5">9.5 mm</option>
                  <option value="11.5">11.5 mm</option>
                </select>
              </div>
              <div class="col-12 d-flex justify-content-center mt-3 gap-2">
                <button type="submit" class="btn btn-primary">Predict</button>
                <button type="button" class="btn btn-secondary" onclick="fillRandom()">Random Autofill</button>
                <button type="button" class="btn btn-danger" onclick="clearScreen()">Clear Screen</button>
              </div>
              
            </div>
          </form>
        </div>
      `;
    }

    async function submitPrediction(event) {
      event.preventDefault();
    
      const form = document.getElementById("predictionForm");
      const formData = new FormData(form);
    
      // Build request body
      const inputData = {};
      formData.forEach((value, key) => {
        inputData[key] = value;
      });
    
      // Add metadata
      inputData["worker_name"] = localStorage.getItem("workerName") || "Unknown";
      inputData["batch_number"] = localStorage.getItem("batchNumber") || "Unknown";
    
      // Set default status
      inputData["status"] = "Pass"; // This can be updated via toggle button after prediction
    
      try {
        const response = await fetch("http://127.0.0.1:5000/predict", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(inputData),
        });
    
        const result = await response.json();
    
        if (result.error) throw new Error(result.error);
    
        // Update results UI
        const resultsHTML = `
          <div class="alert alert-success rounded">
            <div>
              <h5 class="mb-2">üîç Prediction Results:</h5>
              <p class="mb-1"><strong>UTS:</strong> ${result.uts} MPa</p>
              <p class="mb-1"><strong>Elongation:</strong> ${result.elongation}%</p>
              <p class="mb-1"><strong>Conductivity:</strong> ${result.conductivity}% IACS</p>
              <p class="mb-1"><strong>Grade:</strong> ${result.grade}</p>
            </div>
            <div class="ms-3 mt-2 mt-md-0 d-flex flex-column gap-2">
              <button class="btn btn-success" onclick="saveResults()">üíæ Save Results</button>
              <button id="statusToggle" class="btn btn-outline-secondary" onclick="togglePassFail()">‚úîÔ∏è Status: Pass</button>
            </div>
          </div>
        `;
    
        const resultsDiv = document.getElementById("results");
        resultsDiv.innerHTML = resultsHTML;
    
        // ‚úÖ Save state to sessionStorage so it persists on reload
        sessionStorage.setItem("hasPredicted", "true");
        sessionStorage.setItem("lastResults", resultsHTML);
    
        // Scroll to bottom of scrollable-content area
        document.querySelector('.scrollable-content').scrollTo({
  top: document.querySelector('.scrollable-content').scrollHeight,
  behavior: 'smooth'
});

    
      } catch (err) {
        alert("‚ùå Prediction failed: " + err.message);
        console.error(err);
      }
    
      console.log("Form submitted without reload!");
    }
    
    
  
    function togglePassFail() {
      const btn = document.getElementById("statusToggle");
      if (btn.innerText.includes("Pass")) {
        btn.innerText = "‚ùå Status: Fail";
        btn.classList.remove("btn-outline-secondary");
        btn.classList.add("btn-outline-danger");
      } else {
        btn.innerText = "‚úîÔ∏è Status: Pass";
        btn.classList.remove("btn-outline-danger");
        btn.classList.add("btn-outline-secondary");
      }
    }

    function saveResults() {
      alert("‚úÖ Results saved successfully!\n(This is a placeholder. Hook to backend or download feature.)");
    }

    function fillRandom() 
    {
      const ranges = {
        fe: [0.18, 0.35], emulsion_temp: [60, 90], emulsion_pr: [1.0, 2.5],
        rod_quench_cw_exit: [1.0, 20.0], rod_quench_cw_entry: [100.0, 500.0],
        casting_wheel_rpm: [1.5, 2.5], rm_motor_cooling_water_pressure: [1.0, 3.5],
        rolling_mill_amp: [200.0, 450.0], cool_water_flow: [100.0, 210.0],
        cooling_water_pressure: [1.5, 4.0], cooling_water_temp: [25.0, 45.0],
        rolling_mill_rpm: [650.0, 950.0]
      };
      Object.entries(ranges).forEach(([key, [min, max]]) => {
        const input = document.querySelector(`input[name="${key}"]`);
        if (input) input.value = (Math.random() * (max - min) + min).toFixed(2);
      });
      const dia = document.querySelector('select[name="diameter"]');
      if (dia) dia.value = ["9.5", "11.5"][Math.floor(Math.random() * 2)];
    }

    function clearScreen() {
      document.querySelectorAll('input').forEach(i => i.value = '');
      document.querySelector('select[name="diameter"]').selectedIndex = 0;
      document.getElementById('results').innerHTML = '';
    }

    function showBatchHistory() {
      //document.getElementById('content-area').innerHTML = '<div class="card"><h4>üì¶ Batch History coming soon...</h4></div>';
      document.getElementById('content-area').innerHTML = `
    <div class="card shadow">
      <h2 class="text-center mb-4">üìÑ Batch History</h2>

      <!-- Filters -->
      <div class="row g-3 mb-4">
        <div class="col-md-3">
          <input type="text" class="form-control" placeholder="Search by Worker" id="filterWorker">
        </div>
        <div class="col-md-3">
          <input type="date" class="form-control" id="filterDate">
        </div>
        <div class="col-md-3">
          <input type="text" class="form-control" placeholder="Batch No" id="filterBatch">
        </div>
        <div class="col-md-3 d-flex gap-2">
          <button class="btn btn-primary w-100" onclick="applyFilters()">Apply Filter</button>
          <button class="btn btn-secondary" onclick="resetFilters()">Reset</button>
        </div>
      </div>

      <!-- History Records -->
      <div id="batchHistoryList">

        ${generateBatchSection("Rahul", "2025-04-09", "A42", [
          { time: "10:03 AM", uts: 123, elong: 8.1, cond: 62, status: "Pass" },
          { time: "11:15 AM", uts: 116, elong: 7.5, cond: 61.8, status: "Pass" },
        ])}

        ${generateBatchSection("Asha", "2025-04-08", "B17", [
          { time: "01:20 PM", uts: 98.4, elong: 6.9, cond: 60.4, status: "Fail" },
        ])}

      </div>
    </div>
  `;
}

function generateBatchSection(worker, date, batch, records) {
  const id = `batch-${worker}-${batch}`.replace(/\s+/g, '-');
  return `
    <div class="accordion mb-3" id="accordion-${id}">
      <div class="accordion-item">
        <h2 class="accordion-header" id="heading-${id}">
          <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapse-${id}">
            üë∑ Worker: <strong class="ms-1">${worker}</strong> | üìÖ Date: <strong>${date}</strong> | üè∑Ô∏è Batch No: <strong>${batch}</strong>
          </button>
        </h2>
        <div id="collapse-${id}" class="accordion-collapse collapse" data-bs-parent="#accordion-${id}">
          <div class="accordion-body">
            <ul class="list-group mb-2">
              ${records.map(r => `
                <li class="list-group-item d-flex justify-content-between align-items-center">
                  ‚è∞ ${r.time} ‚Äî UTS: ${r.uts} MPa, Elongation: ${r.elong}%, Conductivity: ${r.cond}% 
                  <span class="badge bg-${r.status === 'Pass' ? 'success' : 'danger'}">${r.status}</span>
                </li>
              `).join('')}
            </ul>
            <button class="btn btn-outline-dark btn-sm" onclick='generatePDF("${worker}", "${date}", "${batch}", ${JSON.stringify(records)})'>üßæ Generate Report</button>
          </div>
        </div>
      </div>
    </div>
  `;
}

function applyFilters() {
  const w = document.getElementById("filterWorker").value.toLowerCase();
  const d = document.getElementById("filterDate").value;
  const b = document.getElementById("filterBatch").value.toLowerCase();

  const allItems = document.querySelectorAll("#batchHistoryList .accordion");
  allItems.forEach(item => {
    const text = item.innerText.toLowerCase();
    const match = (!w || text.includes(w)) && (!d || text.includes(d)) && (!b || text.includes(b));
    item.style.display = match ? "block" : "none";
  });
}

function resetFilters() {
  document.getElementById("filterWorker").value = '';
  document.getElementById("filterDate").value = '';
  document.getElementById("filterBatch").value = '';
  applyFilters();
}
    
async function generatePDF(worker, date, batch, records) {
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF();

  doc.setFontSize(16);
  doc.text("Wire Rod Batch Report", 20, 20);
  doc.setFontSize(12);
  doc.text(`Worker: ${worker}`, 20, 30);
  doc.text(`Date: ${date}`, 20, 38);
  doc.text(`Batch No: ${batch}`, 20, 46);

  let y = 60;
  records.forEach((r, index) => {
    doc.text(`${index + 1}. Time: ${r.time} | UTS: ${r.uts} MPa | Elong: ${r.elong}% | Cond: ${r.cond}% | Status: ${r.status}`, 20, y);
    y += 10;
  });

  doc.save(`Batch_${batch}_Report.pdf`);
}

    function showDashboard() {
      document.getElementById('content-area').innerHTML = '<div class="card"><h4>üìä Dashboard coming soon...</h4></div>';
    }

    //showPredictProperties();
    document.addEventListener("DOMContentLoaded", () => {
      const contentArea = document.getElementById("content-area");
    
      // Always show the form
      showPredictProperties();
    
      // Restore results if needed
      const savedResults = sessionStorage.getItem("lastResults");
      if (savedResults) {
        document.getElementById('results').innerHTML = savedResults;
      }
    });
    
     
  </script>
</body>
</html>
